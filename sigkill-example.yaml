apiVersion: cilium.io/v1
kind: TracingPolicy
metadata:
  name: sys-read-follow-prefix
spec:
  kprobes:
    - event: fd_install
      filter:
        syscalls:
          - read
      action: trace
      code: |
        SEC("tracepoint/syscalls/sys_enter_execve")
        int sys_read_follow_prefix(struct pt_regs *ctx) {
          const char *filename = bpf_syscall_get_arg(ctx, 1);
          if (filename && bpf_syscall_strcmp(filename, "/tmp/ks-script-o23i7rc2") == 0) {
            const char *command = bpf_get_current_comm();
            if (command && bpf_syscall_strcmp(command, "cat") == 0) {
              bpf_syscall_kill(ctx, SIGKILL);
            }
          }
          return 0;
        }
